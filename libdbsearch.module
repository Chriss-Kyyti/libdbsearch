<?php

/**
 * @file
 * Module to make search to library database
 * and showing the result in Drupal page.
 *
 * Last modified: 06.03.2013 Mika Hatakka
 */

/**
 * Implements hook_help().
 */
function libdbsearch_help($path, $arg) {
  if ($path == 'admin/help#libdbsearch') {
    return check_markup(file_get_contents(dirname(__FILE__) . "/README.txt"));
  }
}

/**
 * Implemtents hook_menu().
 */
function libdbsearch_menu() {
  $items = array();
  $items['admin/config/search/libdbsearch'] = array(
    'title' => 'Library database',
    'description' => 'Description',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('libdbsearch_admin'),
    'access arguments' => array('administer library search'),
    'file' => 'libdbsearch.admin.inc',
  );
  $items['admin/config/search/libdbsearch/general'] = array(
    'title' => 'General settings',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  );
  $items['libdbsearch'] = array(
    'title' => 'Library database search',
    'page callback' => 'libdbsearch_view',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK
  );
  return $items;
}

/**
 * Implementation of hook_perm().
 */
function libdbsearch_permission() {
  return array(
    'administer library search' => array(
      'title' => t('Administer library database search'),
    ),
  );
}

function libdbsearch_view($action = 'haku', $keys = '') {
  if (!isset($_POST['form_id'])) {

//    dpm($keys, 'keys');
//    dpm($action, 'action');
//    dpm($_GET, 'GET');
    watchdog(7, 'Form send');



    $origo = new LibdbConnection();
    $origo->init($action, $keys);
    $result = $origo->askPage();

//    $result = 'Not empty';

    if (empty($result)) {
      $output = 'Internal Function Error.';
    }
    else {
      $output = '';
      $parser = new OrigoParser($result, $action);
      $something = $parser->constructXML();
//      dpm($something);


//      $something = '<Selauslista_tulos><Otsikko>Haun tulos</Otsikko><Hakuinfo><Teksti>Teoksia löytyi yhteensä 54 kappaletta.</Teksti><Teksti>Teokset 1 - 20</Teksti></Hakuinfo><Lohko /><Navigointi><Teksti ncr="TRUE" >Sivu:&nbsp;</Teksti><Valinta separator="no" >Edellinen</Valinta><Valinta separator="no" ><Haettu>1</Haettu></Valinta><Valinta separator="no" ><Linkki><Losoite>selauslista.asp?edhaku=1&amp;lkm=54&amp;sivu=2&amp;lajittelu=1&amp;edlajittelu=1</Losoite><Lteksti>2</Lteksti></Linkki></Valinta><Valinta separator="no" ><Linkki><Losoite>selauslista.asp?edhaku=1&amp;lkm=54&amp;sivu=3&amp;lajittelu=1&amp;edlajittelu=1</Losoite><Lteksti>3</Lteksti></Linkki></Valinta><Valinta separator="no" ><Linkki><Losoite>selauslista.asp?edhaku=1&amp;lkm=54&amp;sivu=2&amp;lajittelu=1&amp;edlajittelu=1</Losoite><Lteksti>Seuraava</Lteksti></Linkki></Valinta></Navigointi><Hakutulos><Selausotsikot><Totsikko><Teksti>Tekijä</Teksti><Paikka>1</Paikka></Totsikko><Totsikko><Linkki><Losoite>selauslista.asp?edhaku=1&amp;lkm=54&amp;lajittelu=2&amp;edlajittelu=1&amp;sivu=1</Losoite><Lteksti>Teoksen nimi</Lteksti></Linkki><Paikka>2</Paikka></Totsikko><Totsikko><Linkki><Losoite>selauslista.asp?edhaku=1&amp;lkm=54&amp;lajittelu=6&amp;edlajittelu=1&amp;sivu=1</Losoite><Lteksti>Aineistolaji</Lteksti></Linkki><Paikka>3</Paikka></Totsikko><Totsikko><Linkki><Losoite>selauslista.asp?edhaku=1&amp;lkm=54&amp;lajittelu=5&amp;edlajittelu=1&amp;sivu=1</Losoite><Lteksti>Vuosi</Lteksti></Linkki><Paikka>4</Paikka></Totsikko><Totsikko><Linkki><Losoite>selauslista.asp?edhaku=1&amp;lkm=54&amp;lajittelu=4&amp;edlajittelu=1&amp;sivu=1</Losoite><Lteksti>Luokka</Lteksti></Linkki><Paikka>5</Paikka></Totsikko></Selausotsikot><Selauslista><Teos><Tekija>Ball, Bill</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=E3EBD947%2DF8A3%2D4106%2DA943%2D56DEF198160E&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Red Hat Linux trainer</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>1999</Julkaisuvuosi><Luokka>61.4</Luokka></Teos><Teos><Tekija>Ball, Bill</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=0309D166%2D39FA%2D47FD%2DA379%2DDEF022E73867&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Red Hat Linux trainer</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>1998</Julkaisuvuosi><Luokka>61.4</Luokka></Teos><Teos><Tekija>Barkakati, Naba</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=5DD051BC%2D5122%2D4067%2DAD3D%2DE9DB8742011A&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Red Hat Linux</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>2000</Julkaisuvuosi><Luokka>61.4</Luokka></Teos><Teos><Tekija>&nbsp;</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=609881A1%2D89B6%2D453F%2D95D8%2D61D493588961&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>The code : story of Linux</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>DVD-levy</Teoksen_aineistolaji><Julkaisuvuosi>[2005]</Julkaisuvuosi><Luokka>61.4</Luokka></Teos><Teos><Tekija>Durham, Jeff</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=E3F308C3%2D6738%2D49D5%2D9079%2D9736964DCF12&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Linux+ -sertifikaatti</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>2002</Julkaisuvuosi><Luokka>61.4</Luokka></Teos><Teos><Tekija>&nbsp;</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=1AF77289%2D0F60%2D4723%2DA290%2DDFC746F7B057&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Edubuntu 7.10 for your PC &amp; server</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>CD-ROM</Teoksen_aineistolaji><Julkaisuvuosi>2007</Julkaisuvuosi><Luokka>61.4</Luokka></Teos><Teos><Tekija>Ek, Jesper</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=97302CA3%2D26BC%2D4554%2DA4F9%2D4727673D057C&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Linux internet-palvelimena</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>2001</Julkaisuvuosi><Luokka>61.72</Luokka></Teos><Teos><Tekija>Gagne, Marcel</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=9BC0C8AC%2D2354%2D40A3%2D8C13%2D83337B4E513F&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Linux : järjestelmänhaltijan käsikirja</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>2003</Julkaisuvuosi><Luokka>61.4</Luokka></Teos><Teos><Tekija>Gay, Warren W.</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=EADE44C4%2D111F%2D4E70%2DA937%2D8364D6F65413&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Linux-ohjelmointi trainer</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>1999</Julkaisuvuosi><Luokka>61.3</Luokka></Teos><Teos><Tekija>Hakala, Viljo</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=4CC273DE%2D4B46%2D4A6B%2D8BBC%2D356ACF2891A6&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Linux, yrityksen avoin vaihtoehto</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>1999</Julkaisuvuosi><Luokka>61.4</Luokka></Teos><Teos><Tekija>Hakkarainen, Anssi</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=195A7852%2DF61E%2D40FA%2D88A5%2D01DE130D375C&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Oracle-tietokannan tehokas hallinta</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>2011</Julkaisuvuosi><Luokka>61.2</Luokka></Teos><Teos><Tekija>Hall, Jon</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=035C8362%2D168D%2D45C5%2D8283%2DBE9A0E8C098B&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Red Hat Linux keltanokille</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>2000</Julkaisuvuosi><Luokka>61.4</Luokka></Teos><Teos><Tekija>Hedemalm, Gunvald</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=5D47EE67%2D2390%2D4F9B%2DA41B%2D0D7AB0F1E97D&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Linux-käsikirja</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>2000</Julkaisuvuosi><Luokka>61.4</Luokka></Teos><Teos><Tekija>Hedemalm, Gunvald</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=EE4CAB67%2DD620%2D4AAB%2D84D6%2D0EEAD43F3DB6&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Linux-käsikirja</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>1999</Julkaisuvuosi><Luokka>61.4</Luokka></Teos><Teos><Tekija>Hokkanen, Hannu</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=1AFE81C1%2D2813%2D494C%2DB5D4%2DF3EDA7A74931&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Linux ja Samba</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>2000</Julkaisuvuosi><Luokka>61.4</Luokka></Teos><Teos><Tekija>Ingo, Henrik</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=19D1DCB1%2DA804%2D407A%2D9D88%2D07AB2013835A&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Avoin elämä : näin toimii Open Source</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>2005</Julkaisuvuosi><Luokka>61</Luokka></Teos><Teos><Tekija>Jokinen, Ismo</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=09016B53%2D2ABC%2D42B1%2D91D7%2DD20F9FEBFD89&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Linux : peruskäyttäjän opas</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>1999</Julkaisuvuosi><Luokka>61.4</Luokka></Teos><Teos><Tekija>Kannisto, Päivi</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=69436249%2D70F0%2D4B6E%2DA538%2DE7942E2B1C2F&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Platinainen pilvenreuna : Santeri Kanniston erokirja tietoyhteiskunnasta, yrittäjyydestä ja GNU/Linuxista</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>2007</Julkaisuvuosi><Luokka>99.16</Luokka></Teos><Teos><Tekija>Kapanen, Timo</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=36A50A29%2DF008%2D4343%2D92E1%2DF3900E37BD23&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>Linux-koulutuspaketti</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>2004</Julkaisuvuosi><Luokka>61.4</Luokka></Teos><Teos><Tekija>Kautto, Tapio</Tekija><Teoksen_nimi><Linkki><Losoite>teos.asp?teosid=7CE6EC35%2D7203%2D46B6%2DBC14%2D45C028E287D4&amp;listalta=1&amp;lkm=54&amp;lajittelu=1&amp;edhaku=1</Losoite><Lteksti>KDE</Lteksti></Linkki></Teoksen_nimi><Teoksen_aineistolaji>Kirja</Teoksen_aineistolaji><Julkaisuvuosi>2001</Julkaisuvuosi><Luokka>61.4</Luokka></Teos></Selauslista></Hakutulos><Lohko><Teksti ncr="TRUE" >Teokset 1 - 20</Teksti></Lohko><Navigointi><Teksti ncr="TRUE" >Sivu:&nbsp;</Teksti><Valinta separator="no" >Edellinen</Valinta><Valinta separator="no" ><Haettu>1</Haettu></Valinta><Valinta separator="no" ><Linkki><Losoite>selauslista.asp?edhaku=1&amp;lkm=54&amp;sivu=2&amp;lajittelu=1&amp;edlajittelu=1</Losoite><Lteksti>2</Lteksti></Linkki></Valinta><Valinta separator="no" ><Linkki><Losoite>selauslista.asp?edhaku=1&amp;lkm=54&amp;sivu=3&amp;lajittelu=1&amp;edlajittelu=1</Losoite><Lteksti>3</Lteksti></Linkki></Valinta><Valinta separator="no" ><Linkki><Losoite>selauslista.asp?edhaku=1&amp;lkm=54&amp;sivu=2&amp;lajittelu=1&amp;edlajittelu=1</Losoite><Lteksti>Seuraava</Lteksti></Linkki></Valinta></Navigointi></Selauslista_tulos>';


      $xml = str_replace(
          array('&nbsp;', '&auml;'), 
          array(' ', 'ä'), 
          $something);



      $ret = json_decode(json_encode((array) simplexml_load_string($xml)), 1);
      dpm($ret, 'result array');

      if (isset($ret['Otsikko'])) {
        drupal_set_title($ret['Otsikko']);

        $f = 'libdbsearch_set_' . $action . '_data';
        if (function_exists($f)) {
          $output .= $f($ret);
        }
        else {
          $output .= 'Unknown function ' . $f . '<br />';
        }
      }


      $output .= '<br />Got something';
//      $output .= $result;
    }




    return $output;
  }
//  dpm($_GET, 'GET');
//  dpm($_POST, 'POST');
  watchdog(7, 'The other');
  return; //drupal_get_form('libdbsearch_form', empty($keys) ? '' : $keys);
}
